# Development

## Components update automation

This repository has to maintain a correct list of components and versions in `snapcraft.yaml`: Tempest itself, python-tempestconf, and the various Tempest plugins we want to bundle. This is particularly important because only specific sets of versions are compatible with each other.

Additionally, it's necessary to keep bundled components up to date as new releases are created upstream.

This process is managed via GitHub workflows stored in a separate repo, [snap-tempest-automation][1].

The workflows run periodically, but can also be triggered manually via the GitHub API.

For any supported OpenStack release, the workflows will generate PRs in this repository from a `release/<codename>` branch, targeting the corresponding `stable/<codename>` one, providing updated component versions. It is possible to affect the algorithm on a per-branch basis by providing two optional files at the root of this present repository:
* `excluded-plugins.txt`: this is a list of Tempest plugin names that should not be bundled in the snap. A default list is held within the  [snap-tempest-automation][1] repo.
* `requirements-manual.txt`: this is a list of additional Python packages that should be bundled in the snap, in PEP440 format. This may sometimes be required to fix missing plugin dependencies. By default, no additional requirements are installed.

As an example, committing an `excluded-plugins.txt` file at the root of the `stable/yoga` branch with the content "`keystone-tempest-plugin`" would cause the automation to propose a PR from `release/yoga` to `stable/yoga` to bundle all known Tempest plugins compatible with OpenStack Yoga, except for the Keystone one.

More details about these workflows are available in the [snap-tempest-automation][1] repo.

## Reviewing automated PRs

The automated PRs generated by the [snap-tempest-automation][1] repo only target the `snapcraft.yaml` file and can be reviewed as follows:
* ensure the expected additional requirements are present/absent based on the `requirements-manual.txt` file
* ensure the list of plugins is as expected, based on the `excluded-plugins.txt` list
* the Tempest version should be set to the latest one found in the deliverables for the relative OpenStack version. For example, the current latest Tempest for Yoga is `yoga-last`[^1], as shown at [openstack/releases/src/branch/master/deliverables/yoga/tempest.yaml][5]
* check that at least some of the Tempest plugin versions are correct, based on what is stored in the [releases][2] repository. For example, the latest Tempest plugin for Glance on OpenStack Bobcat is 1.10.0 as of this writing, as visible [here][3]. Note: do not rely on the versions indicated in the [release docs][4] as that page may lag behind the [releases][2] repository
* we should always include the [latest tempestconf version][6]


[1]: https://github.com/canonical/snap-tempest-automation
[2]: https://opendev.org/openstack/releases/src/branch/master/deliverables
[3]: https://opendev.org/openstack/releases/src/branch/master/deliverables/bobcat/glance-tempest-plugin.yaml#L12
[4]: https://releases.openstack.org/bobcat/index.html#tempest-plugins
[5]: https://opendev.org/openstack/releases/src/branch/master/deliverables/yoga/tempest.yaml
[6]: https://pypi.org/project/python-tempestconf/#history
[7]: https://docs.openstack.org/tempest/latest/tempest_and_plugins_compatible_version_policy.html

[^1]: `<release>-last` indicates the last supported version for a given release. See the [Tempest and Plugins compatible version policy][7]

# Preparing a new release

This is the procedure for releasing a new version of the tempest snap and target a new OpenStack release. This example will target 2024.1 / Caracal, but should be applicable to future releases of OpenStack as well.

1. request a new snap track in the Snapcraft discourse. Here is [the Caracal request][8] as a reference
1. create a new `stable/caracal` branch in this repository, branching off `main`
1. create an initial branch protection rule for the new branch (the content doesn't matter so much; the rule will be updated by solutions-engineering-automation later; the automation just can't create the rule first)
1. in solutions-engineering-automation, open a PR to add a new config file for the new branch (copy an existing config, eg. [`terraform-plans/configs/snap-tempest_stable_zed.tfvars`][14]), and add a new entry to the terraform job list in [`.github/workflows/terraform-apply.yaml`][15]
1. add the the `caracal` release to the [update-tempest-releases.yaml][9] matrix strategy
1. wait for the `Update Tempest Releases` workflow to run, or trigger a manual run
1. review and merge the resulting PR in this repository. Reference PR [#160][10]
1. create a new snap recipe at [this link][11], using the new branch and track as input and output, respectively. An [existing recipe][12] can be used as a reference
1. the built snap will be published under `2024.1/candidate`. Test and if happy with the result
1. promote the snap to stable
1. switch the default track to `2024.1`
1. update the [`tempest-latest`][13] recipe to build from `stable/caracal`


[8]: https://forum.snapcraft.io/t/2024-1-track-request-for-tempest/39761/1
[9]: https://github.com/canonical/snap-tempest-automation/blob/main/.github/workflows/update-tempest-releases.yaml
[10]: https://github.com/canonical/snap-tempest/pull/160
[11]: https://launchpad.net/snap-tempest/+new-snap
[12]: https://launchpad.net/~tempest-snappers/snap-tempest/+snap/tempest-2023.2
[13]: https://launchpad.net/~tempest-snappers/snap-tempest/+snap/tempest-latest
[14]: https://github.com/canonical/solutions-engineering-automation/blob/main/terraform-plans/configs/snap-tempest_stable_zed.tfvars
[15]: https://github.com/canonical/solutions-engineering-automation/blob/main/.github/workflows/terraform-apply.yaml
