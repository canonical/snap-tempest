# Components update automation

This repository has to maintain a correct list of components and versions in `snapcraft.yaml`: Tempest itself, python-tempestconf, and the various Tempest plugins we want to bundle. This is particularly important because only specific sets of versions are compatible with each other.

Additionally, we need to ensure we update the bundled components as new releases are created upstream.

This process is managed via GitHub workflows stored in a separate repo, [snap-tempest-automation][1].

The workflows run periodically, but can also be triggered manually via the GitHub API.

For any supported OpenStack release, the workflows will generate PRs in this repository from a `release/<codename>` branch, targeting the corresponding `stable/<codename>` one, providing updated component versions. It is possible to affect the algorithm on a per-branch basis by providing two optional files at the root of this present repository:
* `excluded-plugins.txt`: this is a list of Tempest plugin names that should not be bundled in the snap. A default list is held within the  [snap-tempest-automation][1] repo.
* `requirements-manual.txt`: this is a list of additional Python packages that should be bundled in the snap, in PEP440 format. This may sometimes be required to fix missing plugin dependencies. By default, no additional requirements are installed.

As an example, committing an `excluded-plugins.txt` file at the root of the `stable/yoga` branch with the content "`keystone-tempest-plugin`" would cause the automation to propose a PR from `release/yoga` to `stable/yoga` to bundle all known Tempest plugins compatible with OpenStack Yoga, except for the Keystone one.

More details about these workflows are available in the [snap-tempest-automation][1] repo.

## Reviewing automated PRs

The automated PRs generated by the [snap-tempest-automation][1] repo only target the `snapcraft.yaml` file and can be reviewed as follows:
* ensure the expected additional requirements are present/absent based on the `requirements-manual.txt` file
* ensure the list of plugins is as expected, based on the `excluded-plugins.txt` list
* the Tempest version should be set to the latest one found in the deliverables for the relative OpenStack version. For example, the current latest Tempest for Yoga is `yoga-last`[^1], as shown at [openstack/releases/src/branch/master/deliverables/yoga/tempest.yaml][5]
* check that at least some of the Tempest plugin versions are correct, based on what is stored in the [releases][2] repository. For example, the latest Tempest plugin for Glance on OpenStack Bobcat is 1.10.0 as of this writing, as visible [here][3]. Note: do not rely on the versions indicated in the [release docs][4] as that page may lag behind the [releases][2] repository
* we should always include the [latest tempestconf version][6]


[0]: https://github.com/canonical/snap-tempest
[1]: https://github.com/canonical/snap-tempest-automation
[2]: https://opendev.org/openstack/releases/src/branch/master/deliverables
[3]: https://opendev.org/openstack/releases/src/branch/master/deliverables/bobcat/glance-tempest-plugin.yaml#L12
[4]: https://releases.openstack.org/bobcat/index.html#tempest-plugins
[5]: https://opendev.org/openstack/releases/src/branch/master/deliverables/yoga/tempest.yaml
[6]: https://pypi.org/project/python-tempestconf/#history
[7]: https://docs.openstack.org/tempest/latest/tempest_and_plugins_compatible_version_policy.html

[^1]: `<release>-last` indicates the last supported version for a given release. See the [Tempest and Plugins compatible version policy][7]